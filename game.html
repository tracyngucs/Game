<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Appointed Time</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

body {
  font-family: sans-serif;
  background-image: url("Christmas-Background2.jpg");
  background-size: cover;      /* fills the whole screen */
  background-position: center; /* centers the image */
  background-repeat: no-repeat;
  background-attachment: fixed; /* keeps it fixed even if content scrolls */
}

/* Add this block to make the Appointed Time text white */
  #homeScreen h1 {
    color: white;
    /* optional for better visibility: */
    text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
  }
  
  /* HOME SCREEN */
  #homeScreen {
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  #homeScreen input {
    padding: 12px;
    font-size: 20px;
    width: 280px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid #aaa;
  }

  #startButton {
    padding: 14px 30px;
    font-size: 22px;
    background: linear-gradient(to bottom, #0B6623, #39A66D); /* Christmas green gradient */
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3), 0 0 8px rgba(0, 128, 0, 0.5); /* subtle glow */
    transition: transform 0.1s, box-shadow 0.2s;
}

#startButton:hover {
    background: linear-gradient(to bottom, #1B7A3D, #50C878); /* brighter on hover */
    transform: translateY(-2px); /* lift effect on hover */
    box-shadow: 0 6px 10px rgba(0,0,0,0.4), 0 0 12px rgba(0, 255, 0, 0.7); /* stronger glow */
}


  /* GAME SCREEN */
  #gameScreen {
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  #playerInfo {
    font-size: 22px;
    margin-bottom: 20px;
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7); /* optional, for better visibility */
}

  #timerButton {
    width: 300px;
    height: 300px;
    border-radius: 150px;
    background: linear-gradient(to bottom, #ff4d4d, #b30000);
    color: white;
    font-size: 48px;
    border: none;
    cursor: pointer;
    box-shadow: 0 10px 20px rgba(0,0,0,0.4), 0 4px 6px rgba(0,0,0,0.2);
    transition: transform 0.1s, box-shadow 0.1s;
  }

  #timerButton:active {
    transform: translateY(4px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.4);
  }

  #timeDisplay {
    margin-top: 20px;
    font-size: 36px;
  }

  #triesDisplay {
    margin-top: 10px;
    font-size: 24px;
  }

  #message {
    margin-top: 10px;
    font-size: 22px;
    color: #333;
  }

  /* SUMMARY BOX */
  #summaryBox {
    margin-top: 20px;
    padding: 15px;
    width: 80%;
    max-width: 400px;
    max-height: 300px;
    overflow-y: auto;
    border: 2px solid #444;
    border-radius: 10px;
    font-size: 18px;
    background: #f7f7f7;
    display: none;
    text-align: left;
  }

  /* END SCREEN WITH SIDEBAR */
  #endScreen {
    display: none;
    flex-direction: column;
    padding: 20px;
  }

  #endContainer {
    display: flex;
    width: 100%;
    max-width: 800px;
  }

  #sidebarButton {
    width: 40px;
    height: 40px;
    background: #333;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    border-radius: 4px;
    margin-right: 20px;
  }

  #sidebarButton div {
    width: 20px;
    height: 3px;
    background: white;
    margin: 2px 0;
  }

  #sidebarButton:hover {
    background: #555;
  }

  #endContent {
    flex: 1;
    padding: 20px;
  }

  #endPlayerInfo {
    font-size: 22px;
    margin-bottom: 10px;
    color: white; /* make player name white */
}

#endMessage {
    font-size: 20px;
    margin-bottom: 10px;
    color: white; /* make "Thanks for playing!" white */
}

  #endSummaryBox {
    max-height: 300px;
    overflow-y: auto;
    border: 2px solid #444;
    border-radius: 10px;
    padding: 10px;
    font-size: 18px;
    background: #f7f7f7;
    text-align: left;
  }

  #playerChoiceEnd {
    margin-top: 20px;
  }

  #playerChoiceEnd span {
    font-size: 18px;
    margin-right: 10px;
  }

  #playerChoiceEnd button {
    margin: 0 10px;
    padding: 10px 20px;
    font-size: 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: linear-gradient(to bottom, #0B6623, #39A66D); /* Christmas green gradient */
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3), 0 0 8px rgba(0, 128, 0, 0.5); /* subtle green glow */
    transition: transform 0.1s, box-shadow 0.2s;
}

#playerChoiceEnd button:hover {
    background: linear-gradient(to bottom, #1B7A3D, #50C878); /* brighter on hover */
    transform: translateY(-2px); /* small lift on hover */
    box-shadow: 0 6px 10px rgba(0,0,0,0.4), 0 0 12px rgba(0, 255, 0, 0.7); /* stronger glow */
}




  /* LEADERBOARD SCREEN */
  #leaderboardScreen {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }

  #leaderboardScreen h1 {
    font-size: 28px;
    margin-bottom: 20px;
    color: white; /* change title to white */
}

  #leaderboardContent {
    width: 100%;
    max-width: 600px;
    border: 2px solid #444;
    border-radius: 10px;
    padding: 15px;
    background: #f7f7f7;
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
    text-align: left;
  }

  #leaderboardButtons {
    display: flex;
    align-items: center;
  }

  #leaderboardButtons span {
    font-size: 18px;
    margin-right: 10px;
  }

  #leaderboardButtons button {
    margin: 0 10px;
    padding: 10px 20px;
    font-size: 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: linear-gradient(to bottom, #0B6623, #39A66D); /* Christmas green gradient */
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3), 0 0 8px rgba(0, 128, 0, 0.5); /* subtle glow */
    transition: transform 0.1s, box-shadow 0.2s;
}

#leaderboardButtons button:hover {
    background: linear-gradient(to bottom, #1B7A3D, #50C878); /* brighter on hover */
    transform: translateY(-2px); /* lift effect on hover */
    box-shadow: 0 6px 10px rgba(0,0,0,0.4), 0 0 12px rgba(0, 255, 0, 0.7); /* stronger glow */
}

</style>
</head>
<body>

<!-- HOME SCREEN -->
<div id="homeScreen">
  <h1>Appointed Time</h1>
  <input type="text" id="playerName" placeholder="Enter Name" /><br>
  <input type="tel" id="playerMobile" placeholder="Enter Mobile Number" /><br>
  <button id="startButton">Start Now</button>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
  <div id="playerInfo"></div>
  <button id="timerButton">Start</button>
  <div id="timeDisplay">0.000 s</div>
  <div id="triesDisplay">Tries: 0 / 10</div>
  <div id="message"></div>
  <div id="summaryBox"></div>
</div>

<!-- END SCREEN -->
<div id="endScreen">
  <div id="endContainer">
    <div id="sidebarButton">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div id="endContent">
      <div id="endPlayerInfo"></div>
      <div id="endMessage"></div>
      <div id="endSummaryBox"></div>
      <div id="playerChoiceEnd">
        <span>Play as:</span>
        <button id="samePlayerBtnEnd">Same Player</button>
        <button id="nextPlayerBtnEnd">Next Player</button>
      </div>
    </div>
  </div>
</div>

<!-- LEADERBOARD SCREEN -->
<div id="leaderboardScreen">
  <h1>Leaderboard</h1>
  <div id="leaderboardContent"></div>
  <div id="leaderboardButtons">
    <span>Play as:</span>
    <button id="samePlayerLeaderboardBtn">Same Player</button>
    <button id="nextPlayerLeaderboardBtn">Next Player</button>
  </div>
</div>

<!-- SOUNDS -->
<audio id="buzzSound" preload="auto">
  <source src="fail-buzzer.wav" type="audio/wav">
</audio>

<audio id="cheerSound" preload="auto">
  <source src="Kids-Cheer.wav" type="audio/wav">
</audio>
  
<!-- BACKGROUND MUSIC -->
<audio id="bgMusic" loop>
  <source src="Music.mp3" type="audio/mpeg">
</audio>

  
<script>
let running = false;
let startTime = 0;
let tries = 0;
let currentResults = [];
let allPlayerScores = [];
let consolidatedResults = {};

let playerNameValue = "";
let playerMobileValue = "";
let lastPlayerName = "";

const homeScreen = document.getElementById('homeScreen');
const gameScreen = document.getElementById('gameScreen');
const endScreen = document.getElementById('endScreen');
const leaderboardScreen = document.getElementById('leaderboardScreen');

const playerInfo = document.getElementById('playerInfo');
const timerButton = document.getElementById('timerButton');
const display = document.getElementById('timeDisplay');
const triesDisplay = document.getElementById('triesDisplay');
const message = document.getElementById('message');
const summaryBox = document.getElementById('summaryBox');

const endPlayerInfo = document.getElementById('endPlayerInfo');
const endMessage = document.getElementById('endMessage');
const endSummaryBox = document.getElementById('endSummaryBox');
const playerChoiceEnd = document.getElementById('playerChoiceEnd');
const samePlayerBtnEnd = document.getElementById('samePlayerBtnEnd');
const nextPlayerBtnEnd = document.getElementById('nextPlayerBtnEnd');
const sidebarButton = document.getElementById('sidebarButton');

const leaderboardContent = document.getElementById('leaderboardContent');
const samePlayerLeaderboardBtn = document.getElementById('samePlayerLeaderboardBtn');
const nextPlayerLeaderboardBtn = document.getElementById('nextPlayerLeaderboardBtn');

const startButton = document.getElementById('startButton');

const buzz = document.getElementById('buzzSound');
const cheer = document.getElementById('cheerSound');

const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyV9OXwo708diV3pLK4mQP2qgcktouHWfPEiAuz9vutMIQO0kBsoxtG59CFbkv8_NXS1g/exec';

async function fetchLeaderboard() {
    const response = await fetch(SHEET_API_URL);
    const data = await response.json();
    return data; // Array of player scores
}
  
/**
 * Sends the game result data to the Google Sheet API.
 * @param {string} name - Player's name.
 * @param {string} mobile - Player's mobile number.
 * @param {number} score - The player's best time (closest to 3s).
 */
async function sendResultToSheet(name, mobile, score, tryNumber) {
    const data = {
        name: name,
        mobile: mobile,
        score: score,
        try: tryNumber
        // Timestamp will be added by the Apps Script server for accuracy
    };

    console.log("Sending data to Google Sheet:", data);

    try {
        const response = await fetch(SHEET_API_URL, {
            method: 'POST',
            mode: 'no-cors', // Required to bypass CORS restrictions for simple submissions
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        // The no-cors mode prevents reading the response, but the data is sent.
        // For a more detailed check, you'd need to set up CORS properly
        // or use an Apps Script feature that allows simple response checks.
        console.log("Data sent (check Google Sheet for confirmation).");

    } catch (error) {
        console.error("Error submitting score to Google Sheet:", error);
        // You might want to alert the user or log this failure
    }
}

// ⭐ HOME SCREEN → GAME START
startButton.addEventListener("click", () => {
    playerNameValue = document.getElementById("playerName").value.trim();
    playerMobileValue = document.getElementById("playerMobile").value.trim();

if (!playerNameValue || !playerMobileValue) {
    alert("Please enter both name and mobile number.");
    return;
}

//<--- paste code here-->
 // ⭐ Play background music on first user interaction
    music.currentTime = 0;
    music.play().catch(() => {
        console.log("Music play blocked by browser.");
    });
//<--End-->
  
// ⭐ Reset try numbers if same player name is typed again
if (playerNameValue === lastPlayerName) {
    consolidatedResults[playerNameValue] = []; // reset entire record
}

// Update last player
lastPlayerName = playerNameValue;

playerInfo.textContent = `Player: ${playerNameValue}`;
homeScreen.style.display = "none";
gameScreen.style.display = "flex";
tries = 0;
display.textContent = "0.000 s";
triesDisplay.textContent = "Tries: 0 / 10";
message.textContent = "";
summaryBox.style.display = "none";
currentResults = [];

if (!consolidatedResults[playerNameValue]) {
    consolidatedResults[playerNameValue] = [];
}

});

// ⭐ Background music setup (runs once, page load)
const music = document.getElementById("bgMusic");
music.volume = 0.4;
music.loop = true;

// ⭐ Play buzz sound independently (over background music)
function playBuzz() {
    // Use the preloaded 'buzz' element instead of creating a new one
    buzz.currentTime = 0; // Rewind to the start just in case it's mid-play
    buzz.play().catch(err => console.log("Buzz blocked:", err));
}


// ⭐ GAME LOGIC
timerButton.addEventListener("click", () => {
    if(tries >= 10 && timerButton.textContent === "Reset"){
        // 1. Save current results
        currentResults.forEach(t=>{
            allPlayerScores.push({name: playerNameValue, time: t});
            consolidatedResults[playerNameValue].push(t);
        });

        // 2. Find the best time for the entire session
        const allResults = consolidatedResults[playerNameValue];
        const bestTime = allResults.reduce((a,b)=> Math.abs(a-3)<Math.abs(b-3)?a:b );
        
        // 3. Continue with game flow
        gameScreen.style.display = "none";
        endScreen.style.display = "flex";
        endPlayerInfo.textContent = `Player: ${playerNameValue}`;
        endMessage.textContent = "Thanks for playing!";
        showEndSummary();
        return;
    }

    if(tries >= 10) return;

    if(!running){
        running = true;
        startTime = performance.now();
        display.textContent = "0.000 s";
        timerButton.textContent = "Stop";
        document.body.style.backgroundColor = "white";
        requestAnimationFrame(updateTimer);
    } else {
        running = false;
        tries++;
        const elapsed = (performance.now() - startTime)/1000;
        const formatted = parseFloat(elapsed.toFixed(3));
        currentResults.push(formatted);

        const cumulativeTryNumber = (consolidatedResults[playerNameValue]?.length || 0) + currentResults.length;

        sendResultToSheet(
        playerNameValue,
        playerMobileValue,
        formatted,
        cumulativeTryNumber
);

      
       display.textContent = formatted.toFixed(3) + " s";
triesDisplay.textContent = "Tries: " + tries + " / 10";

if (formatted === 3.000) {
    document.body.style.backgroundColor = "green";
    timerButton.textContent = "You Win!";
    cheer.currentTime = 0;
    cheer.play().catch(() => console.log("Cheer blocked"));
} else {
    document.body.style.backgroundColor = "red";
    timerButton.textContent = "Try Again";
    
    playBuzz(); 


}

if (tries >= 10) timerButton.textContent = "Reset";

    }
});

function updateTimer(){
    if(running){
        const elapsed = (performance.now() - startTime)/1000;
        display.textContent = elapsed.toFixed(3) + " s";
        requestAnimationFrame(updateTimer);
    }
}

function showEndSummary(){
    const allResults = consolidatedResults[playerNameValue];
    endSummaryBox.innerHTML = "";
    if(!allResults || allResults.length===0) return;
    const bestTime = allResults.reduce((a,b)=> Math.abs(a-3)<Math.abs(b-3)?a:b );
    allResults.forEach((t,i)=> 
    endSummaryBox.innerHTML += `Try ${i+1}: ${t.toFixed(3)} s<br>`
);

endSummaryBox.innerHTML += `<br><b>Best Time (closest to 3s):</b> ${bestTime.toFixed(3)} s`;
}

// ⭐ SAME PLAYER / NEXT PLAYER
samePlayerBtnEnd.addEventListener("click", ()=>{
    endScreen.style.display="none";
    gameScreen.style.display="flex";
    tries=0;
    display.textContent="0.000 s";
    triesDisplay.textContent="Tries: 0 / 10";
    message.textContent="";
    currentResults=[];
    summaryBox.style.display="none";
    timerButton.textContent="Start";
    document.body.style.backgroundColor="white";
});

nextPlayerBtnEnd.addEventListener("click", ()=>{
    endScreen.style.display="none";
    homeScreen.style.display="flex";
    currentResults=[];
    tries=0;
    document.getElementById("playerName").value="";
    document.getElementById("playerMobile").value="";
    timerButton.textContent = "Start";
    homeScreen.style.backgroundColor = "#ffffff";
});

// ⭐ SIDEBAR → LEADERBOARD (updated for dynamic leaderboard)
sidebarButton.addEventListener("click", async () => {
    endScreen.style.display = "none";
    leaderboardScreen.style.display = "flex";
    await populateLeaderboard(); // ensures it always shows latest scores
});


async function populateLeaderboard() {
    try {
        leaderboardContent.innerHTML = "Loading...";  // temp text

        const response = await fetch(SHEET_API_URL);
        const data = await response.json();

        const sorted = data.sort((a,b) => Math.abs(a.score - 3) - Math.abs(b.score - 3));
        const top10 = sorted.slice(0,10);

        // Build the whole HTML in memory first
        let html = "";
        top10.forEach((p, i) => {
            html += `${i+1}. ${p.name}: ${p.score.toFixed(3)} s<br>`;
        });

        // Update DOM ONCE
        leaderboardContent.innerHTML = html;

    } catch (err) {
        leaderboardContent.innerHTML = "Failed to load leaderboard.";
    }
}


// ⭐ LEADERBOARD BUTTONS
samePlayerLeaderboardBtn.addEventListener("click", ()=>{
    leaderboardScreen.style.display="none";
    gameScreen.style.display="flex";
    tries=0;
    display.textContent="0.000 s";
    triesDisplay.textContent="Tries: 0 / 10";
    message.textContent="";
    currentResults=[];
    timerButton.textContent="Start";
    document.body.style.backgroundColor="white";
});

nextPlayerLeaderboardBtn.addEventListener("click", ()=>{
    leaderboardScreen.style.display="none";
    homeScreen.style.display="flex";
    currentResults=[];
    tries=0;
    document.getElementById("playerName").value="";
    document.getElementById("playerMobile").value="";
});
</script>

  

</body>
</html>
