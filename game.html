<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Appointed Time</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    background: white;
  }

  /* HOME SCREEN */
  #homeScreen {
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  #homeScreen input {
    padding: 12px;
    font-size: 20px;
    width: 280px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid #aaa;
  }

  #startButton {
    padding: 14px 30px;
    font-size: 22px;
    background: #0077cc;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }

  /* GAME SCREEN */
  #gameScreen {
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  #playerInfo {
    font-size: 22px;
    margin-bottom: 20px;
  }

  #timerButton {
    width: 300px;
    height: 300px;
    border-radius: 150px;
    background: linear-gradient(to bottom, #ff4d4d, #b30000);
    color: white;
    font-size: 48px;
    border: none;
    cursor: pointer;
    box-shadow: 0 10px 20px rgba(0,0,0,0.4), 0 4px 6px rgba(0,0,0,0.2);
    transition: transform 0.1s, box-shadow 0.1s;
  }

  #timerButton:active {
    transform: translateY(4px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.4);
  }

  #timeDisplay {
    margin-top: 20px;
    font-size: 36px;
  }

  #triesDisplay {
    margin-top: 10px;
    font-size: 24px;
  }

  #message {
    margin-top: 10px;
    font-size: 22px;
    color: #333;
  }

  /* SUMMARY BOX */
  #summaryBox {
    margin-top: 20px;
    padding: 15px;
    width: 80%;
    max-width: 400px;
    max-height: 300px;
    overflow-y: auto;
    border: 2px solid #444;
    border-radius: 10px;
    font-size: 18px;
    background: #f7f7f7;
    display: none;
    text-align: left;
  }

  /* END SCREEN WITH SIDEBAR */
  #endScreen {
    display: none;
    flex-direction: column;
    padding: 20px;
  }

  #endContainer {
    display: flex;
    width: 100%;
    max-width: 800px;
  }

  #sidebarButton {
    width: 40px;
    height: 40px;
    background: #333;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    border-radius: 4px;
    margin-right: 20px;
  }

  #sidebarButton div {
    width: 20px;
    height: 3px;
    background: white;
    margin: 2px 0;
  }

  #sidebarButton:hover {
    background: #555;
  }

  #endContent {
    flex: 1;
    padding: 20px;
  }

  #endPlayerInfo {
    font-size: 22px;
    margin-bottom: 10px;
  }

  #endMessage {
    font-size: 20px;
    margin-bottom: 10px;
  }

  #endSummaryBox {
    max-height: 300px;
    overflow-y: auto;
    border: 2px solid #444;
    border-radius: 10px;
    padding: 10px;
    font-size: 18px;
    background: #f7f7f7;
    text-align: left;
  }

  #playerChoiceEnd {
    margin-top: 20px;
  }

  #playerChoiceEnd span {
    font-size: 18px;
    margin-right: 10px;
  }

  #playerChoiceEnd button {
    margin: 0 10px;
    padding: 10px 20px;
    font-size: 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #0077cc;
    color: white;
  }

  #playerChoiceEnd button:hover {
    background: #005fa3;
  }

  /* LEADERBOARD SCREEN */
  #leaderboardScreen {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }

  #leaderboardScreen h1 {
    font-size: 28px;
    margin-bottom: 20px;
  }

  #leaderboardContent {
    width: 100%;
    max-width: 600px;
    border: 2px solid #444;
    border-radius: 10px;
    padding: 15px;
    background: #f7f7f7;
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
    text-align: left;
  }

  #leaderboardButtons {
    display: flex;
    align-items: center;
  }

  #leaderboardButtons span {
    font-size: 18px;
    margin-right: 10px;
  }

  #leaderboardButtons button {
    margin: 0 10px;
    padding: 10px 20px;
    font-size: 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #0077cc;
    color: white;
  }

  #leaderboardButtons button:hover {
    background: #005fa3;
  }
</style>
</head>
<body>

<!-- HOME SCREEN -->
<div id="homeScreen">
  <h1>Appointed Time</h1>
  <input type="text" id="playerName" placeholder="Enter Name" /><br>
  <input type="tel" id="playerMobile" placeholder="Enter Mobile Number" /><br>
  <button id="startButton">Start Now</button>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
  <div id="playerInfo"></div>
  <button id="timerButton">Start</button>
  <div id="timeDisplay">0.000 s</div>
  <div id="triesDisplay">Tries: 0 / 10</div>
  <div id="message"></div>
  <div id="summaryBox"></div>
</div>

<!-- END SCREEN -->
<div id="endScreen">
  <div id="endContainer">
    <div id="sidebarButton">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div id="endContent">
      <div id="endPlayerInfo"></div>
      <div id="endMessage"></div>
      <div id="endSummaryBox"></div>
      <div id="playerChoiceEnd">
        <span>Play as:</span>
        <button id="samePlayerBtnEnd">Same Player</button>
        <button id="nextPlayerBtnEnd">Next Player</button>
      </div>
    </div>
  </div>
</div>

<!-- LEADERBOARD SCREEN -->
<div id="leaderboardScreen">
  <h1>Leaderboard</h1>
  <div id="leaderboardContent"></div>
  <div id="leaderboardButtons">
    <span>Play as:</span>
    <button id="samePlayerLeaderboardBtn">Same Player</button>
    <button id="nextPlayerLeaderboardBtn">Next Player</button>
  </div>
</div>

<!-- SOUNDS -->
<audio id="buzzSound" preload="auto">
  <source src="fail-buzzer-04.wav" type="audio/wav">
</audio>

<audio id="cheerSound" preload="auto">
  <source src="Kids Cheer.wav" type="audio/wav">
</audio>

<script>
let running = false;
let startTime = 0;
let tries = 0;
let currentResults = [];
let allPlayerScores = [];
let consolidatedResults = {};

let playerNameValue = "";
let playerMobileValue = "";

const homeScreen = document.getElementById('homeScreen');
const gameScreen = document.getElementById('gameScreen');
const endScreen = document.getElementById('endScreen');
const leaderboardScreen = document.getElementById('leaderboardScreen');

const playerInfo = document.getElementById('playerInfo');
const timerButton = document.getElementById('timerButton');
const display = document.getElementById('timeDisplay');
const triesDisplay = document.getElementById('triesDisplay');
const message = document.getElementById('message');
const summaryBox = document.getElementById('summaryBox');

const endPlayerInfo = document.getElementById('endPlayerInfo');
const endMessage = document.getElementById('endMessage');
const endSummaryBox = document.getElementById('endSummaryBox');
const playerChoiceEnd = document.getElementById('playerChoiceEnd');
const samePlayerBtnEnd = document.getElementById('samePlayerBtnEnd');
const nextPlayerBtnEnd = document.getElementById('nextPlayerBtnEnd');
const sidebarButton = document.getElementById('sidebarButton');

const leaderboardContent = document.getElementById('leaderboardContent');
const samePlayerLeaderboardBtn = document.getElementById('samePlayerLeaderboardBtn');
const nextPlayerLeaderboardBtn = document.getElementById('nextPlayerLeaderboardBtn');

const startButton = document.getElementById('startButton');

const buzz = document.getElementById('buzzSound');
const cheer = document.getElementById('cheerSound');

const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyV9OXwo708diV3pLK4mQP2qgcktouHWfPEiAuz9vutMIQO0kBsoxtG59CFbkv8_NXS1g/exec';

/**
 * Sends the game result data to the Google Sheet API.
 * @param {string} name - Player's name.
 * @param {string} mobile - Player's mobile number.
 * @param {string} score - The player's time for this try (formatted string).
 * @param {number} tryNumber - The attempt number (1 to 10).
 */
async function sendResultToSheet(name, mobile, score, tryNumber) { // ✅ FIXED: Added tryNumber to the signature
    const data = {
        name: name,
        mobile: mobile,
        score: score,
        try: tryNumber, // This is now correctly defined
        // Timestamp will be added by the Apps Script server for accuracy
    };

    console.log("Sending data to Google Sheet:", data);

    try {
        const response = await fetch(SHEET_API_URL, {
            method: 'POST',
            mode: 'no-cors', // Required to bypass CORS restrictions for simple submissions
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        console.log("Data sent (check Google Sheet for confirmation).");
    } catch (error) {
        console.error("Error submitting score to Google Sheet:", error);
    }
}

// ⭐ HOME SCREEN → GAME START
startButton.addEventListener("click", () => {
    playerNameValue = document.getElementById("playerName").value.trim();
    playerMobileValue = document.getElementById("playerMobile").value.trim();
    if(!playerNameValue || !playerMobileValue){
        alert("Please enter both name and mobile number.");
        return;
    }
    playerInfo.textContent = `Player: ${playerNameValue}`;
    homeScreen.style.display = "none";
    gameScreen.style.display = "flex";
    tries = 0;
    display.textContent = "0.000 s";
    triesDisplay.textContent = "Tries: 0 / 10";
    message.textContent = "";
    summaryBox.style.display = "none";
    currentResults = [];
    if(!consolidatedResults[playerNameValue]) consolidatedResults[playerNameValue] = [];
});

// ⭐ GAME LOGIC
timerButton.addEventListener("click", () => {
    if(tries >= 10 && timerButton.textContent === "Reset"){
        // 1. Save current results
        currentResults.forEach(t=>{
            allPlayerScores.push({name: playerNameValue, time: t});
            consolidatedResults[playerNameValue].push(t);
        });
        
        // ❌ REMOVED: No need to send data here, as it's sent after every try.
        
        // 2. Continue with game flow
        gameScreen.style.display = "none";
        endScreen.style.display = "flex";
        endPlayerInfo.textContent = `Player: ${playerNameValue}`;
        endMessage.textContent = "Thanks for playing!";
        showEndSummary();
        return;
    }

    if(tries >= 10) return;

    if(!running){
        running = true;
        startTime = performance.now();
        display.textContent = "0.000 s";
        timerButton.textContent = "Stop";
        document.body.style.backgroundColor = "white";
        requestAnimationFrame(updateTimer);
    } else {
        running = false;
        tries++;
        const elapsed = (performance.now() - startTime)/1000;
        const formatted = parseFloat(elapsed.toFixed(3));
        currentResults.push(formatted);
        display.textContent = formatted.toFixed(3) + " s";
        triesDisplay.textContent = "Tries: " + tries + " / 10";

        // ✅ CORRECT: This call now matches the updated function signature
        sendResultToSheet(playerNameValue, playerMobileValue, formatted.toFixed(3), tries);
      
        if(formatted === 3.000){
            document.body.style.backgroundColor = "green";
            timerButton.textContent = "You Win!";
            cheer.currentTime=0; cheer.play();
        } else {
            document.body.style.backgroundColor = "red";
            timerButton.textContent = "Try Again";
            buzz.currentTime=0; buzz.play();
        }
        if(tries >= 10) timerButton.textContent = "Reset";
    }
});

function updateTimer(){
    // ... (rest of the functions remain the same)
}
// ...
</script>

</body>
</html>
